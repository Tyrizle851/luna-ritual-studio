{
  "name": "Instagram Ad Engine v2 (Sora Backup)",
  "nodes": [
    {
      "parameters": {
        "rule": {"interval": [{"field": "hours", "hoursInterval": 8}]}
      },
      "name": "Every 8 Hours",
      "type": "n8n-nodes-base.scheduleTrigger",
      "position": [240, 400]
    },
    {
      "parameters": {
        "url": "https://raw.githubusercontent.com/Tyrizle851/luna-ritual-studio/claude/analyze-ecommerce-repo-011CUmX7vgr4TvhMyFqheZMx/automation/data/products.json"
      },
      "name": "Fetch Products",
      "type": "n8n-nodes-base.httpRequest",
      "position": [440, 400]
    },
    {
      "parameters": {
        "jsCode": "let products=$input.all()[0].json;if(!Array.isArray(products)){if(products.products)products=products.products;else products=[products]}const now=new Date();const available=products.filter(p=>{if(!p.last_posted)return true;const days=(now-new Date(p.last_posted))/(1000*60*60*24);return days>3});const pool=available.length>0?available:products;const selected=pool[Math.floor(Math.random()*pool.length)];return[{json:selected}];"
      },
      "name": "Select Product",
      "type": "n8n-nodes-base.code",
      "position": [640, 400]
    },
    {
      "parameters": {
        "jsCode": "const map={'aff-001':'affirmation-rest.jpg','aff-002':'affirmation-joy.jpg','aff-003':'affirmation-abundance.jpg','aff-004':'affirmation-trust.jpg','aff-005':'affirmation-enough.jpg','aff-006':'affirmation-calm.jpg','aff-007':'affirmation-receive.jpg','aff-008':'affirmation-honor.jpg','aff-009':'affirmation-release.jpg','aff-010':'affirmation-natural-joy.jpg','aff-011':'affirmation-safe.jpg','aff-012':'affirmation-voice.jpg','aff-013':'affirmation-dreams.jpg','aff-014':'affirmation-peace.jpg','aff-015':'affirmation-progress.jpg','aff-016':'affirmation-intuition.jpg','aff-017':'affirmation-miracles.jpg','aff-018':'affirmation-feel.jpg','aff-019':'affirmation-creating.jpg','aff-020':'affirmation-possibility.jpg','aff-021':'affirmation-change.jpg','aff-022':'affirmation-productive-rest.jpg','aff-023':'affirmation-attract.jpg','aff-024':'affirmation-duality.jpg','cnd-001':'product-candle-1.jpg','cnd-002':'product-candle-2.jpg','cnd-003':'product-candle-1.jpg','cnd-004':'product-candle-2.jpg','cnd-005':'product-candle-1.jpg','cnd-006':'product-candle-2.jpg','cnd-007':'product-candle-1.jpg','cnd-008':'product-candle-2.jpg','cnd-009':'product-candle-1.jpg','cnd-010':'product-candle-2.jpg','cnd-011':'product-candle-1.jpg','cnd-012':'product-candle-2.jpg','cnd-013':'product-candle-1.jpg','cnd-014':'product-candle-2.jpg','cnd-015':'product-candle-1.jpg','fsh-001':'product-linen-robe.jpg','fsh-002':'product-hoops.jpg','fsh-003':'product-market-tote.jpg','fsh-004':'product-silk-sleep-set.jpg','fsh-005':'product-gold-necklace.jpg','fsh-006':'product-cotton-tee.jpg','fsh-007':'product-linen-pants.jpg','fsh-008':'product-cashmere-cardigan.jpg','fsh-009':'product-leather-bag.jpg','fsh-010':'product-scrunchies.jpg','fsh-011':'product-fedora.jpg','fsh-012':'product-sunglasses.jpg','fsh-013':'product-linen-shirt.jpg','fsh-014':'product-beanie.jpg','fsh-015':'product-slip-dress.jpg'};const p=$input.item.json;const img=map[p.id]||'product-candle-1.jpg';const url=`https://raw.githubusercontent.com/Tyrizle851/luna-ritual-studio/claude/analyze-ecommerce-repo-011CUmX7vgr4TvhMyFqheZMx/src/assets/${img}`;return[{json:{...p,original_image_url:url,image_filename:img}}];"
      },
      "name": "Map to Real Image",
      "type": "n8n-nodes-base.code",
      "position": [840, 400]
    },
    {
      "parameters": {
        "url": "={{$json.original_image_url}}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file",
              "outputPropertyName": "original_image"
            }
          }
        }
      },
      "name": "Fetch Original Image",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1040, 400]
    },
    {
      "parameters": {
        "resource": "text",
        "modelId": "gpt-4-turbo",
        "prompt": "=Create Instagram ad for: {{$json.name}} (${{$json.price}}). {{$json.description}}. Return JSON: {\"caption\":\"...\",\"hashtags\":[...],\"image_prompt\":\"Enhanced advertising photo based on original - professional, Instagram-ready, same product but elevated\"}"
      },
      "name": "Generate Ad Copy",
      "type": "n8n-nodes-base.openAi",
      "position": [1240, 400]
    },
    {
      "parameters": {
        "jsCode": "let c;if($input.item.json.choices&&$input.item.json.choices[0])c=$input.item.json.choices[0].message.content;else if($input.item.json.message&&$input.item.json.message.content)c=$input.item.json.message.content;else if($input.item.json.content)c=$input.item.json.content;else c=JSON.stringify($input.item.json);c=c.replace(/```json\\n?/g,'').replace(/```\\n?/g,'').trim();try{const p=JSON.parse(c);return{json:{product:$node['Map to Real Image'].json,caption:p.caption,hashtags:p.hashtags,image_prompt:p.image_prompt}}}catch(e){return{json:{product:$node['Map to Real Image'].json,caption:c.substring(0,200),hashtags:['wellness','selfcare','lunarituals'],image_prompt:`Enhanced ${$node['Map to Real Image'].json.name} product photo`}}}"
      },
      "name": "Parse Response",
      "type": "n8n-nodes-base.code",
      "position": [1440, 400]
    },
    {
      "parameters": {
        "resource": "image",
        "model": "dall-e-3",
        "prompt": "={{$json.image_prompt}}. Reference style from original but create professional Instagram ad version. Same product, elevated presentation.",
        "options": {"size": "1024x1024", "quality": "hd"}
      },
      "name": "Try DALL-E",
      "type": "n8n-nodes-base.openAi",
      "position": [1640, 300],
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "string": [{
            "value1": "={{$node['Try DALL-E'].json}}",
            "operation": "isEmpty"
          }]
        }
      },
      "name": "DALL-E Failed?",
      "type": "n8n-nodes-base.if",
      "position": [1840, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/videos/generations",
        "authentication": "oAuth2",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {"name": "model", "value": "sora-turbo"},
            {"name": "prompt", "value": "={{$node['Parse Response'].json.image_prompt}}. 5 second product showcase video, smooth camera movement"},
            {"name": "size", "value": "1080x1080"}
          ]
        }
      },
      "name": "Sora 2 Video",
      "type": "n8n-nodes-base.httpRequest",
      "position": [2040, 500],
      "notes": "Fallback if DALL-E fails"
    },
    {
      "parameters": {
        "command": "ffmpeg -i {{$json.video_url}} -ss 2 -vframes 1 /tmp/sora_frame.jpg && convert /tmp/sora_frame.jpg -gravity South -chop 0x80 /tmp/sora_clean.jpg"
      },
      "name": "Extract Frame & Remove Watermark",
      "type": "n8n-nodes-base.executeCommand",
      "position": [2240, 500],
      "notes": "Takes frame at 2s, removes bottom 80px (watermark)"
    },
    {
      "parameters": {
        "url": "file:///tmp/sora_clean.jpg",
        "options": {
          "response": {
            "response": {"responseFormat": "file"}
          }
        }
      },
      "name": "Load Clean Image",
      "type": "n8n-nodes-base.httpRequest",
      "position": [2440, 500]
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition"
      },
      "name": "Merge Results",
      "type": "n8n-nodes-base.merge",
      "position": [2040, 300]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [{
            "name": "summary",
            "value": "=âœ… AD READY!\\nProduct: {{$node['Parse Response'].json.product.name}}\\nPrice: ${{$node['Parse Response'].json.product.price}}\\n\\nCaption:\\n{{$node['Parse Response'].json.caption}}\\n\\nHashtags:\\n{{$node['Parse Response'].json.hashtags.join(' #')}}\\n\\nImage: {{$json.url||'Generated'}}\\nSource: {{$node['Try DALL-E'].json?'DALL-E':'Sora 2'}}"
          }]
        }
      },
      "name": "Success",
      "type": "n8n-nodes-base.set",
      "position": [2240, 300]
    }
  ],
  "connections": {
    "Every 8 Hours": {"main": [[{"node": "Fetch Products"}]]},
    "Fetch Products": {"main": [[{"node": "Select Product"}]]},
    "Select Product": {"main": [[{"node": "Map to Real Image"}]]},
    "Map to Real Image": {"main": [[{"node": "Fetch Original Image"}]]},
    "Fetch Original Image": {"main": [[{"node": "Generate Ad Copy"}]]},
    "Generate Ad Copy": {"main": [[{"node": "Parse Response"}]]},
    "Parse Response": {"main": [[{"node": "Try DALL-E"}]]},
    "Try DALL-E": {"main": [[{"node": "DALL-E Failed?"}]]},
    "DALL-E Failed?": {
      "main": [
        [{"node": "Merge Results"}],
        [{"node": "Sora 2 Video"}]
      ]
    },
    "Sora 2 Video": {"main": [[{"node": "Extract Frame & Remove Watermark"}]]},
    "Extract Frame & Remove Watermark": {"main": [[{"node": "Load Clean Image"}]]},
    "Load Clean Image": {"main": [[{"node": "Merge Results"}]]},
    "Merge Results": {"main": [[{"node": "Success"}]]}
  }
}
